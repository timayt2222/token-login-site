<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Token Vault</title>

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --bg: #0b0f17;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --text: #e9eefc;
      --muted: rgba(233,238,252,0.7);
      --border: rgba(233,238,252,0.14);
      --shadow: 0 20px 60px rgba(0,0,0,0.45);
      --accent: #7c5cff;
      --accent2: #33d6ff;
      --danger: #ff4d6d;
      --ok: #33ff88;
      --warn: #ffd166;
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    [data-theme="light"]{
      --bg: #f6f7fb;
      --panel: rgba(0,0,0,0.04);
      --panel2: rgba(0,0,0,0.06);
      --text: #121826;
      --muted: rgba(18,24,38,0.65);
      --border: rgba(18,24,38,0.12);
      --shadow: 0 20px 60px rgba(10,20,40,0.12);
      --accent: #5b5cff;
      --accent2: #00a3d1;
      --danger: #e23b57;
      --ok: #00b86b;
      --warn: #c48a00;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(124,92,255,0.35), transparent 60%),
                  radial-gradient(1100px 650px at 90% 0%, rgba(51,214,255,0.25), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 28px;
    }

    .app{
      width: min(1100px, 100%);
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
    }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .sidebar{
      padding: 18px;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px 4px;
    }

    .brand h1{
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.2px;
    }

    .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }

    .tabs{
      display:flex;
      gap: 8px;
      padding: 10px;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 999px;
    }

    .tab{
      flex:1;
      border: 0;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 999px;
      background: transparent;
      color: var(--muted);
      font-weight: 650;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      transition: 150ms ease;
    }
    .tab:hover{ background: rgba(255,255,255,0.06); color: var(--text); }
    .tab.active{
      background: rgba(124,92,255,0.22);
      color: var(--text);
      border: 1px solid rgba(124,92,255,0.30);
    }

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 12px;
      cursor:pointer;
      transition: 150ms ease;
      font-weight: 700;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.07); }
    .btn:disabled{ opacity:0.55; cursor:not-allowed; transform:none; }
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,92,255,0.95), rgba(51,214,255,0.55));
      border: 1px solid rgba(124,92,255,0.4);
    }
    .btn.danger{
      background: rgba(255,77,109,0.12);
      border-color: rgba(255,77,109,0.25);
      color: var(--text);
    }
    .btn.ghost{
      background: transparent;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ display:flex; flex-direction:column; gap:10px; }

    label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      margin-left: 4px;
    }

    input, textarea{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      outline: none;
      font-weight: 650;
    }
    textarea{ min-height: 86px; resize: vertical; font-family: var(--mono); font-weight: 700; }
    input::placeholder, textarea::placeholder{ color: rgba(233,238,252,0.45); }

    .main{
      padding: 18px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      min-height: 520px;
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 6px 6px 0;
    }

    .header h2{
      margin:0;
      font-size: 18px;
    }
    .header p{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .status{
      font-family: var(--mono);
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      white-space: pre-wrap;
    }

    .divider{
      height:1px;
      background: var(--border);
      margin: 4px 0;
    }

    .hidden{ display:none !important; }

    .tokenbox{
      font-family: var(--mono);
      font-size: 13px;
      padding: 12px;
      border-radius: 14px;
      border: 1px dashed rgba(124,92,255,0.55);
      background: rgba(124,92,255,0.10);
      word-break: break-all;
    }

    .dashTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }

    .project{
      padding: 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .drop{
      border: 1px dashed rgba(51,214,255,0.45);
      background: rgba(51,214,255,0.10);
      border-radius: 16px;
      padding: 18px;
      text-align:center;
      transition: 120ms ease;
      cursor:pointer;
      user-select:none;
    }
    .drop.drag{
      transform: scale(1.01);
      background: rgba(51,214,255,0.16);
    }
    .drop strong{ display:block; font-size: 14px; }
    .drop span{ display:block; color: var(--muted); font-size: 12px; margin-top: 6px; }

    .files{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .file{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
    }
    .file .name{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .file .name b{
      font-family: var(--mono);
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 520px;
    }
    .file .meta{
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
    }

    .toast{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .toast.ok{ border-color: rgba(0,184,107,0.35); background: rgba(0,184,107,0.10); color: var(--text); }
    .toast.err{ border-color: rgba(226,59,87,0.35); background: rgba(226,59,87,0.10); color: var(--text); }
    .toast.warn{ border-color: rgba(196,138,0,0.30); background: rgba(196,138,0,0.10); color: var(--text); }

    .small{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <div class="card sidebar">
      <div class="brand">
        <div>
          <h1>Token Vault</h1>
          <div class="sub">Cloudflare Pages + KV â€¢ no R2 â€¢ free vibes</div>
        </div>

        <button id="themeBtn" class="btn ghost" title="Toggle theme" style="padding:10px 12px;border-radius:14px;">
          <i data-lucide="moon"></i>
        </button>
      </div>

      <div class="pill">
        <i data-lucide="zap"></i>
        <span><b>2MB</b> per file â€¢ stored in KV (base64)</span>
      </div>

      <div class="tabs">
        <button id="tabRegister" class="tab active"><i data-lucide="user-plus"></i> Register</button>
        <button id="tabLogin" class="tab"><i data-lucide="key"></i> Login</button>
      </div>

      <div id="panelRegister" class="col">
        <div class="col">
          <label>Username (auto)</label>
          <input id="regUsername" placeholder="altsagent12345" />
          <button id="btnRegister" class="btn primary"><i data-lucide="sparkles"></i> Create account</button>
        </div>

        <div id="regResult" class="col hidden">
          <div class="divider"></div>
          <div class="small">Hereâ€™s your token. Save it â€” itâ€™s your login.</div>
          <div id="regToken" class="tokenbox"></div>
          <div class="row">
            <button id="btnCopyToken" class="btn"><i data-lucide="copy"></i> Copy</button>
            <button id="btnDownloadToken" class="btn"><i data-lucide="download"></i> token.txt</button>
            <button id="btnGoDashFromReg" class="btn primary"><i data-lucide="layout-dashboard"></i> Dashboard</button>
          </div>
        </div>
      </div>

      <div id="panelLogin" class="col hidden">
        <div class="col">
          <label>Token</label>
          <textarea id="loginToken" placeholder="Paste token here..."></textarea>
          <button id="btnLogin" class="btn primary"><i data-lucide="log-in"></i> Login</button>
          <div class="small">Tip: token is saved in your browser after login (localStorage).</div>
        </div>
      </div>

      <div class="divider"></div>

      <div id="authMini" class="col hidden">
        <div class="toast ok">
          <i data-lucide="badge-check"></i>
          <div>
            <div><b id="authUser">Logged in</b></div>
            <div class="small" id="authTokenShort"></div>
          </div>
        </div>
        <div class="row">
          <button id="btnLogout" class="btn"><i data-lucide="log-out"></i> Logout</button>
          <button id="btnGoDash" class="btn primary"><i data-lucide="layout-dashboard"></i> Dashboard</button>
        </div>
      </div>

      <div class="divider"></div>
      <div id="status" class="status">Ready.</div>
    </div>

    <!-- Main -->
    <div class="card main">
      <div class="header">
        <div>
          <h2 id="mainTitle">Welcome</h2>
          <p id="mainDesc">Register or login with your token. Then manage your one-and-only project dashboard.</p>
        </div>
        <div class="pill">
          <i data-lucide="cloud"></i>
          <span>Cloudflare Free Plan friendly</span>
        </div>
      </div>

      <div id="welcomeArea" class="project">
        <div class="toast warn">
          <i data-lucide="info"></i>
          <div>
            <b>Heads up</b>
            <div class="small">
              If your KV binding name isnâ€™t exactly <b>TOKENS</b>, nothing will work.
            </div>
          </div>
        </div>
        <div class="small">
          Routes used:
          <div class="status" style="margin-top:8px">
POST /api/register
POST /api/login
POST /api/upload-file  (multipart/form-data, header x-auth-token)
GET  /api/files-list   (header x-auth-token)
DELETE /api/delete-file (json body, header x-auth-token)
DELETE /api/delete-account (json body)
          </div>
        </div>
      </div>

      <div id="dashArea" class="project hidden">
        <div class="dashTop">
          <div>
            <div class="pill">
              <i data-lucide="folder-kanban"></i>
              <span><b>Project:</b> TokenVault Files</span>
            </div>
            <div class="small" style="margin-top:8px">
              Upload, list, delete. Stored as base64 in KV under <span style="font-family:var(--mono)">&lt;token&gt;/files/&lt;filename&gt;</span>.
            </div>
          </div>
          <div class="row">
            <button id="btnRefresh" class="btn"><i data-lucide="refresh-ccw"></i> Refresh</button>
            <button id="btnDeleteAccount" class="btn danger"><i data-lucide="trash-2"></i> Delete account</button>
          </div>
        </div>

        <input id="filePicker" type="file" multiple class="hidden" />

        <div id="drop" class="drop">
          <strong><i data-lucide="upload"></i> Drag & drop files here</strong>
          <span>or click to browse â€¢ max 2MB each â€¢ multiple allowed</span>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="pill">
            <i data-lucide="files"></i>
            <span><b id="fileCount">0</b> files</span>
          </div>
          <div class="small">Tip: filenames are stored exactly â€” donâ€™t upload duplicates unless you want overwrite.</div>
        </div>

        <div id="files" class="files"></div>

        <div id="deleteBox" class="col hidden" style="margin-top:6px">
          <div class="toast err">
            <i data-lucide="alert-triangle"></i>
            <div>
              <b>Delete account</b>
              <div class="small">This deletes your token + all files. Type <b>Delete Account</b> to confirm.</div>
            </div>
          </div>
          <div class="row" style="align-items:center">
            <input id="deleteConfirm" placeholder="Type: Delete Account" />
            <button id="btnConfirmDelete" class="btn danger"><i data-lucide="trash"></i> Confirm</button>
            <button id="btnCancelDelete" class="btn"><i data-lucide="x"></i> Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // --------------------
  // Config
  // --------------------
  const MAX_FILE_BYTES = 2 * 1024 * 1024;

  // --------------------
  // Helpers
  // --------------------
  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");

  function setStatus(msg){
    statusEl.textContent = msg;
  }

  function shortToken(t){
    if(!t) return "";
    const s = String(t).trim();
    if(s.length <= 14) return s;
    return s.slice(0, 8) + "â€¦" + s.slice(-6);
  }

  function randomUsername(){
    const prefixes = ["swift", "roblox", "altsagent"];
    const p = prefixes[Math.floor(Math.random() * prefixes.length)];
    const n = Math.floor(10000 + Math.random() * 90000);
    return `${p}${n}`;
  }

  function saveAuth(token, username){
    localStorage.setItem("tv_token", token);
    localStorage.setItem("tv_user", username);
  }

  function clearAuth(){
    localStorage.removeItem("tv_token");
    localStorage.removeItem("tv_user");
  }

  function getAuth(){
    return {
      token: localStorage.getItem("tv_token") || "",
      username: localStorage.getItem("tv_user") || ""
    };
  }

  async function api(path, { method="GET", token=null, json=null, form=null } = {}){
    const headers = {};
    if(token) headers["x-auth-token"] = token;

    let body;
    if(json){
      headers["content-type"] = "application/json";
      body = JSON.stringify(json);
    }else if(form){
      body = form; // browser sets boundary
    }

    const res = await fetch(path, { method, headers, body });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

    if(!res.ok){
      const msg = (data && data.error) ? data.error : `Request failed (${res.status})`;
      throw new Error(msg);
    }
    return data;
  }

  function downloadText(filename, text){
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // --------------------
  // Theme
  // --------------------
  function applyTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("tv_theme", theme);
    // swap icon
    const themeBtn = $("themeBtn");
    themeBtn.innerHTML = theme === "light"
      ? '<i data-lucide="sun"></i>'
      : '<i data-lucide="moon"></i>';
    lucide.createIcons();
  }

  // --------------------
  // UI State
  // --------------------
  function showTab(which){
    $("tabRegister").classList.toggle("active", which === "register");
    $("tabLogin").classList.toggle("active", which === "login");
    $("panelRegister").classList.toggle("hidden", which !== "register");
    $("panelLogin").classList.toggle("hidden", which !== "login");
  }

  function showDashboard(on){
    $("welcomeArea").classList.toggle("hidden", on);
    $("dashArea").classList.toggle("hidden", !on);

    $("mainTitle").textContent = on ? "Dashboard" : "Welcome";
    $("mainDesc").textContent = on
      ? "Upload your files, list them, delete them â€” all stored in KV under your token."
      : "Register or login with your token. Then manage your one-and-only project dashboard.";
  }

  function renderAuthMini(){
    const { token, username } = getAuth();
    const loggedIn = !!token && !!username;
    $("authMini").classList.toggle("hidden", !loggedIn);
    if(loggedIn){
      $("authUser").textContent = `@${username}`;
      $("authTokenShort").textContent = `token: ${shortToken(token)}`;
    }
  }

  // --------------------
  // Dashboard: Files
  // --------------------
  function fileRow({ filename, meta }){
    const div = document.createElement("div");
    div.className = "file";

    const left = document.createElement("div");
    left.className = "name";
    left.innerHTML = `<i data-lucide="file"></i> <b title="${filename}">${filename}</b>`;

    const right = document.createElement("div");
    right.className = "row";
    right.style.alignItems = "center";

    const metaEl = document.createElement("div");
    metaEl.className = "meta";
    if(meta){
      const size = meta.size ?? 0;
      const type = meta.type ?? "unknown";
      metaEl.textContent = `${(size/1024).toFixed(1)}KB â€¢ ${type}`;
    }else{
      metaEl.textContent = "â€”";
    }

    const del = document.createElement("button");
    del.className = "btn danger";
    del.style.padding = "10px 12px";
    del.innerHTML = `<i data-lucide="trash-2"></i> Delete`;
    del.onclick = async () => {
      if(!confirm(`Delete "${filename}" ?`)) return;
      try{
        const { token } = getAuth();
        setStatus(`Deleting ${filename}...`);
        await api("/api/delete-file", { method:"DELETE", token, json:{ filename } });
        setStatus(`Deleted ${filename}.`);
        await refreshFiles();
      }catch(e){
        setStatus("Delete failed: " + e.message);
        alert(e.message);
      }
    };

    right.appendChild(metaEl);
    right.appendChild(del);

    div.appendChild(left);
    div.appendChild(right);
    return div;
  }

  async function refreshFiles(){
    const { token } = getAuth();
    if(!token) return;

    setStatus("Loading files...");
    const data = await api("/api/files-list", { method:"GET", token });
    const list = data.files || [];

    $("fileCount").textContent = list.length;

    const container = $("files");
    container.innerHTML = "";

    if(list.length === 0){
      const empty = document.createElement("div");
      empty.className = "toast";
      empty.innerHTML = `<i data-lucide="inbox"></i><div><b>No files yet</b><div class="small">Upload something ðŸ‘€</div></div>`;
      container.appendChild(empty);
    }else{
      for(const item of list){
        container.appendChild(fileRow(item));
      }
    }

    lucide.createIcons();
    setStatus("Files loaded.");
  }

  async function uploadFiles(files){
    const { token } = getAuth();
    if(!token) throw new Error("Not logged in.");

    const tooBig = [...files].find(f => f.size > MAX_FILE_BYTES);
    if(tooBig) throw new Error(`"${tooBig.name}" is bigger than 2MB.`);

    const form = new FormData();
    for(const f of files) form.append("files", f, f.name);

    setStatus(`Uploading ${files.length} file(s)...`);
    const data = await api("/api/upload-file", { method:"POST", token, form });
    setStatus(`Uploaded: ${data.saved?.length || 0} file(s).`);
    await refreshFiles();
  }

  // --------------------
  // Init + Events
  // --------------------
  (function init(){
    // theme
    const savedTheme = localStorage.getItem("tv_theme") || "dark";
    applyTheme(savedTheme);

    $("themeBtn").onclick = () => {
      const current = document.documentElement.getAttribute("data-theme") || "dark";
      applyTheme(current === "dark" ? "light" : "dark");
    };

    // tabs
    $("tabRegister").onclick = () => showTab("register");
    $("tabLogin").onclick = () => showTab("login");

    // register username auto
    $("regUsername").value = randomUsername();

    // register
    $("btnRegister").onclick = async () => {
      try{
        const username = $("regUsername").value.trim() || randomUsername();
        setStatus("Registering...");
        const data = await api("/api/register", { method:"POST", json:{ username } });

        const token = data.token;
        $("regToken").textContent = token;
        $("regResult").classList.remove("hidden");

        // store but donâ€™t auto-login unless you go dashboard
        saveAuth(token, data.username);

        renderAuthMini();
        setStatus("Registered. Token created.");

      }catch(e){
        setStatus("Register failed: " + e.message);
        alert(e.message);
      }
    };

    $("btnCopyToken").onclick = async () => {
      const t = $("regToken").textContent.trim();
      if(!t) return;
      await navigator.clipboard.writeText(t);
      setStatus("Token copied to clipboard.");
    };

    $("btnDownloadToken").onclick = () => {
      const t = $("regToken").textContent.trim();
      if(!t) return;
      downloadText("token.txt", t + "\n");
      setStatus("Downloaded token.txt");
    };

    $("btnGoDashFromReg").onclick = async () => {
      const auth = getAuth();
      if(!auth.token) return;
      showDashboard(true);
      await refreshFiles();
    };

    // login
    $("btnLogin").onclick = async () => {
      try{
        const token = $("loginToken").value.trim();
        if(!token) throw new Error("Paste a token.");
        setStatus("Logging in...");
        const data = await api("/api/login", { method:"POST", json:{ token } });
        saveAuth(token, data.username);
        renderAuthMini();
        setStatus("Logged in.");
        showDashboard(true);
        await refreshFiles();
      }catch(e){
        setStatus("Login failed: " + e.message);
        alert(e.message);
      }
    };

    // logout
    $("btnLogout").onclick = () => {
      clearAuth();
      renderAuthMini();
      showDashboard(false);
      setStatus("Logged out.");
    };

    $("btnGoDash").onclick = async () => {
      const auth = getAuth();
      if(!auth.token || !auth.username){
        alert("Login first.");
        return;
      }
      showDashboard(true);
      await refreshFiles();
    };

    // dashboard upload drop
    const drop = $("drop");
    const picker = $("filePicker");

    drop.onclick = () => picker.click();

    drop.addEventListener("dragover", (e) => {
      e.preventDefault();
      drop.classList.add("drag");
    });

    drop.addEventListener("dragleave", () => drop.classList.remove("drag"));

    drop.addEventListener("drop", async (e) => {
      e.preventDefault();
      drop.classList.remove("drag");
      const files = e.dataTransfer.files;
      if(!files || files.length === 0) return;
      try{ await uploadFiles(files); }
      catch(err){ setStatus("Upload failed: " + err.message); alert(err.message); }
    });

    picker.addEventListener("change", async () => {
      if(!picker.files || picker.files.length === 0) return;
      try{ await uploadFiles(picker.files); }
      catch(err){ setStatus("Upload failed: " + err.message); alert(err.message); }
      picker.value = "";
    });

    // refresh
    $("btnRefresh").onclick = async () => {
      try{ await refreshFiles(); }
      catch(e){ setStatus("Refresh failed: " + e.message); alert(e.message); }
    };

    // delete account flow
    $("btnDeleteAccount").onclick = () => {
      $("deleteBox").classList.remove("hidden");
      $("deleteConfirm").value = "";
      $("deleteConfirm").focus();
    };

    $("btnCancelDelete").onclick = () => {
      $("deleteBox").classList.add("hidden");
    };

    $("btnConfirmDelete").onclick = async () => {
      try{
        const text = $("deleteConfirm").value.trim();
        if(text !== "Delete Account") throw new Error('Type exactly: Delete Account');
        const { token } = getAuth();
        if(!token) throw new Error("Not logged in.");

        setStatus("Deleting account...");
        await api("/api/delete-account", { method:"DELETE", json:{ token } });

        clearAuth();
        renderAuthMini();
        showDashboard(false);
        $("deleteBox").classList.add("hidden");
        setStatus("Account deleted.");
        alert("Account deleted.");
      }catch(e){
        setStatus("Delete failed: " + e.message);
        alert(e.message);
      }
    };

    // auto login on load
    const auth = getAuth();
    renderAuthMini();
    if(auth.token){
      // try verify token quietly
      api("/api/login", { method:"POST", json:{ token: auth.token } })
        .then((data) => {
          saveAuth(auth.token, data.username);
          renderAuthMini();
          showDashboard(true);
          return refreshFiles();
        })
        .catch(() => {
          clearAuth();
          renderAuthMini();
          showDashboard(false);
        });
    }

    // icons
    lucide.createIcons();
  })();
</script>
</body>
</html>
