<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Token Vault</title>

  <!-- FIXED lucide import -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --bg:#ffffff;
      --bg2:#f6f8ff;
      --card:#ffffff;
      --text:#0b1222;
      --muted:rgba(11,18,34,.62);
      --border:rgba(11,18,34,.12);
      --shadow:0 18px 55px rgba(10,20,40,.10);

      --blue:#2563eb;
      --blue2:#1d4ed8;
      --glow:rgba(37,99,235,.22);

      --danger:#e23b57;

      --r:18px;
      --r2:14px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    [data-theme="dark"]{
      --bg:#0b0f17;
      --bg2:#0f1624;
      --card:#101a2b;
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.68);
      --border:rgba(234,240,255,.14);
      --shadow:0 22px 70px rgba(0,0,0,.45);

      --blue:#3b82f6;
      --blue2:#2563eb;
      --glow:rgba(59,130,246,.26);

      --danger:#ff4d6d;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .wrap{ width:min(1100px, 100%); }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand b{ font-size:16px; letter-spacing:.2px; }
    .brand span{ font-size:12px; color:var(--muted); font-weight:700; }

    .btn{
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      padding:12px 14px;
      border-radius:var(--r2);
      cursor:pointer;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:10px;
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease, background 120ms ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(1px) scale(.99); }

    .btn.primary{
      background: var(--blue);
      border-color: rgba(37,99,235,.35);
      color:#fff;
    }
    .btn.primary:hover{
      box-shadow: 0 0 22px var(--glow);
      filter: brightness(1.03);
    }

    .btn.danger{
      border-color: rgba(226,59,87,.28);
      color: var(--danger);
    }
    .btn.icon{
      width:46px; height:46px;
      padding:0;
      justify-content:center;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .pad{ padding:18px; }

    .tabs{
      display:flex;
      gap:8px;
      background: rgba(37,99,235,.06);
      border:1px solid rgba(37,99,235,.18);
      padding:8px;
      border-radius:999px;
    }

    .tab{
      flex:1;
      border:0;
      background:transparent;
      cursor:pointer;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      color:var(--muted);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:120ms ease;
    }
    .tab.active{
      background:#fff;
      color:var(--text);
      border:1px solid var(--border);
    }
    [data-theme="dark"] .tab.active{ background:rgba(255,255,255,.06); }

    label{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      margin-left:4px;
    }
    input, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:var(--r2);
      padding:12px 12px;
      font-weight:800;
      color:var(--text);
      background: rgba(0,0,0,.02);
      outline:none;
    }
    [data-theme="dark"] input,[data-theme="dark"] textarea{
      background: rgba(255,255,255,.04);
    }
    textarea{ min-height:92px; resize:vertical; font-family:var(--mono); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:10px; }

    .status{
      margin-top:12px;
      padding:10px 12px;
      border-radius:var(--r2);
      border:1px solid var(--border);
      color:var(--muted);
      font-family:var(--mono);
      font-size:12px;
      background: rgba(0,0,0,.02);
    }
    [data-theme="dark"] .status{ background: rgba(255,255,255,.04); }

    .hidden{ display:none !important; }

    /* Dashboard area */
    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .sectionTitle b{ font-size:16px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      background: rgba(0,0,0,.02);
    }
    [data-theme="dark"] .pill{ background: rgba(255,255,255,.04); }

    .drop{
      border:1px dashed rgba(37,99,235,.35);
      background: rgba(37,99,235,.06);
      border-radius:var(--r);
      padding:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:120ms ease;
      user-select:none;
      min-height:82px;
    }
    .drop:hover{ box-shadow: 0 0 22px var(--glow); }
    .drop.drag{ transform: scale(1.01); }

    .files{ display:flex; flex-direction:column; gap:10px; }
    .file{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:var(--r2);
      border:1px solid var(--border);
      background: rgba(0,0,0,.01);
    }
    [data-theme="dark"] .file{ background: rgba(255,255,255,.04); }

    .fileLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .fileLeft b{
      font-family:var(--mono);
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:520px;
    }
    .meta{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }

    .tokenBox{
      border:1px dashed rgba(37,99,235,.35);
      background: rgba(37,99,235,.06);
      border-radius:var(--r2);
      padding:12px;
      font-family:var(--mono);
      font-size:13px;
      word-break: break-all;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">
        <b>Token Vault</b>
        <span>One project • max 10 files • 2MB each</span>
      </div>
      <button id="themeBtn" class="btn icon" title="Theme"><i data-lucide="sun"></i></button>
    </div>

    <!-- AUTH VIEW -->
    <div id="viewAuth" class="card">
      <div class="grid">
        <div class="pad">
          <div class="tabs">
            <button id="tabRegister" class="tab active"><i data-lucide="user-plus"></i> Register</button>
            <button id="tabLogin" class="tab"><i data-lucide="key"></i> Login</button>
          </div>

          <div style="height:14px"></div>

          <div id="panelRegister" class="col">
            <label>Username</label>
            <input id="regUsername" placeholder="altsagent12345" />
            <button id="btnRegister" class="btn primary"><i data-lucide="sparkles"></i> Create</button>

            <div id="regResult" class="col hidden" style="margin-top:8px">
              <div id="regToken" class="tokenBox"></div>
              <div class="row">
                <button id="btnCopyToken" class="btn"><i data-lucide="copy"></i> Copy</button>
                <button id="btnDownloadToken" class="btn"><i data-lucide="download"></i> token.txt</button>
                <button id="btnGoDashFromReg" class="btn primary"><i data-lucide="layout-dashboard"></i> Dashboard</button>
              </div>
            </div>
          </div>

          <div id="panelLogin" class="col hidden">
            <label>Token</label>
            <textarea id="loginToken" placeholder="Paste token here..."></textarea>
            <button id="btnLogin" class="btn primary"><i data-lucide="log-in"></i> Login</button>
          </div>

          <div id="statusAuth" class="status">Ready.</div>
        </div>

        <div class="pad">
          <div class="sectionTitle">
            <b>Register → Dashboard</b>
            <span class="pill"><i data-lucide="shield"></i> Token login</span>
          </div>

          <div class="file">
            <div class="fileLeft"><i data-lucide="folder"></i><b>Project required</b></div>
            <div class="meta">No project → no files</div>
          </div>
          <div class="file">
            <div class="fileLeft"><i data-lucide="files"></i><b>Max 10 files</b></div>
            <div class="meta">Server enforced</div>
          </div>
          <div class="file">
            <div class="fileLeft"><i data-lucide="database"></i><b>KV only</b></div>
            <div class="meta">Free plan friendly</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DASH VIEW -->
    <div id="viewDash" class="card hidden" style="margin-top:16px;">
      <div class="pad">
        <div class="sectionTitle">
          <div class="row">
            <span class="pill"><i data-lucide="badge-check"></i> <span id="dashUser">@user</span></span>
            <span class="pill"><i data-lucide="key-round"></i> <span id="dashTokenShort" style="font-family:var(--mono)"></span></span>
          </div>

          <div class="row">
            <button id="btnRun" class="btn primary"><i data-lucide="play"></i> Run</button>
            <button id="btnLogout" class="btn"><i data-lucide="log-out"></i> Logout</button>
          </div>
        </div>

        <!-- PROJECT GATE -->
        <div id="projectGate" class="file">
          <div class="fileLeft"><i data-lucide="folder-plus"></i><b>Create Project</b></div>
          <button id="btnCreateProject" class="btn primary"><i data-lucide="plus"></i> Create</button>
        </div>

        <!-- FILES -->
        <div id="filesArea" class="hidden">
          <div class="row" style="justify-content:space-between; margin:12px 0;">
            <span class="pill"><i data-lucide="files"></i> <b id="fileCount">0</b></span>
            <div class="row">
              <button id="btnRefresh" class="btn"><i data-lucide="refresh-ccw"></i> Refresh</button>
              <button id="btnDeleteAccount" class="btn danger"><i data-lucide="trash-2"></i> Delete account</button>
            </div>
          </div>

          <input id="filePicker" type="file" multiple class="hidden" />

          <div id="drop" class="drop">
            <div class="row">
              <i data-lucide="upload"></i>
              <b>Upload files</b>
            </div>
          </div>

          <div style="height:12px"></div>
          <div id="files" class="files"></div>

          <div id="deleteBox" class="col hidden" style="margin-top:12px">
            <input id="deleteConfirm" placeholder="Type: Delete Account" />
            <div class="row">
              <button id="btnConfirmDelete" class="btn danger"><i data-lucide="trash"></i> Confirm</button>
              <button id="btnCancelDelete" class="btn"><i data-lucide="x"></i> Cancel</button>
            </div>
          </div>

          <div id="statusDash" class="status">Ready.</div>
        </div>
      </div>
    </div>

  </div>

<script>
  const MAX_FILE_BYTES = 2 * 1024 * 1024;

  const $ = (id) => document.getElementById(id);

  const viewAuth = $("viewAuth");
  const viewDash = $("viewDash");

  const statusAuth = $("statusAuth");
  const statusDash = $("statusDash");

  function setStatus(msg){
    statusAuth.textContent = msg;
    if(statusDash) statusDash.textContent = msg;
  }

  function randomUsername(){
    const prefixes = ["swift","roblox","altsagent"];
    const n = Math.floor(10000 + Math.random() * 90000);
    return `${prefixes[Math.floor(Math.random()*prefixes.length)]}${n}`;
  }

  function shortToken(t){
    if(!t) return "";
    t = String(t).trim();
    if(t.length <= 14) return t;
    return t.slice(0,8) + "…" + t.slice(-6);
  }

  function saveAuth(token, username){
    localStorage.setItem("tv_token", token);
    localStorage.setItem("tv_user", username);
  }
  function clearAuth(){
    localStorage.removeItem("tv_token");
    localStorage.removeItem("tv_user");
  }
  function getAuth(){
    return {
      token: localStorage.getItem("tv_token") || "",
      username: localStorage.getItem("tv_user") || ""
    };
  }

  async function api(path, { method="GET", token=null, json=null, form=null } = {}){
    const headers = {};
    if(token) headers["x-auth-token"] = token;

    let body;
    if(json){
      headers["content-type"] = "application/json";
      body = JSON.stringify(json);
    }else if(form){
      body = form;
    }

    const res = await fetch(path, { method, headers, body });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw:text }; }

    if(!res.ok){
      const msg = data?.error || data?.raw || `Request failed (${res.status})`;
      throw new Error(msg);
    }
    return data;
  }

  function downloadText(filename, text){
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function applyTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("tv_theme", theme);
    const icon = theme === "light" ? "sun" : "moon";
    $("themeBtn").innerHTML = `<i data-lucide="${icon}"></i>`;
    lucide.createIcons();
  }

  function showAuth(){
    viewAuth.classList.remove("hidden");
    viewDash.classList.add("hidden");
    setStatus("Ready.");
  }

  async function showDash(){
    viewAuth.classList.add("hidden");
    viewDash.classList.remove("hidden");

    const { token, username } = getAuth();
    $("dashUser").textContent = `@${username || "user"}`;
    $("dashTokenShort").textContent = shortToken(token);
    lucide.createIcons();

    await syncProjectUI();
  }

  async function syncProjectUI(){
    const { token } = getAuth();
    setStatus("Loading...");
    const data = await api("/api/project", { method:"GET", token });
    const hasProject = !!data.project;

    $("projectGate").classList.toggle("hidden", hasProject);
    $("filesArea").classList.toggle("hidden", !hasProject);

    if(hasProject){
      await refreshFiles(true);
    }else{
      $("files").innerHTML = "";
      $("fileCount").textContent = "0";
      setStatus("Ready.");
    }
  }

  function fmtKB(bytes){
    return `${(bytes/1024).toFixed(1)}KB`;
  }

  function renderFileRow(item){
    const { filename, meta } = item;

    const row = document.createElement("div");
    row.className = "file";

    const left = document.createElement("div");
    left.className = "fileLeft";
    left.innerHTML = `<i data-lucide="file"></i><b title="${filename}">${filename}</b>`;

    const right = document.createElement("div");
    right.className = "row";

    const metaEl = document.createElement("div");
    metaEl.className = "meta";
    metaEl.textContent = meta ? `${fmtKB(meta.size||0)} • ${meta.type||"file"}` : "—";

    const btnDl = document.createElement("button");
    btnDl.className = "btn";
    btnDl.innerHTML = `<i data-lucide="download"></i>`;
    btnDl.onclick = async () => {
      try{
        const { token } = getAuth();
        setStatus("Downloading...");
        const res = await fetch(`/api/download-file?filename=${encodeURIComponent(filename)}`, {
          headers: { "x-auth-token": token }
        });
        if(!res.ok) throw new Error(await res.text() || "Download failed");
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setStatus("Ready.");
      }catch(e){
        setStatus("Download failed.");
        alert(e.message);
      }
    };

    const btnDel = document.createElement("button");
    btnDel.className = "btn danger";
    btnDel.innerHTML = `<i data-lucide="trash-2"></i>`;
    btnDel.onclick = async () => {
      if(!confirm(`Delete "${filename}"?`)) return;
      try{
        const { token } = getAuth();
        setStatus("Deleting...");
        await api("/api/delete-file", { method:"DELETE", token, json:{ filename } });
        await refreshFiles(true);
        setStatus("Ready.");
      }catch(e){
        setStatus("Delete failed.");
        alert(e.message);
      }
    };

    right.appendChild(metaEl);
    right.appendChild(btnDl);
    right.appendChild(btnDel);

    row.appendChild(left);
    row.appendChild(right);
    return row;
  }

  async function refreshFiles(retry=false){
    const { token } = getAuth();
    setStatus("Loading files...");
    let data = await api("/api/files-list", { method:"GET", token });

    // KV can lag right after upload → tiny retry helps
    if(retry && Array.isArray(data.files) && data.files.length === 0){
      await new Promise(r => setTimeout(r, 350));
      data = await api("/api/files-list", { method:"GET", token });
    }

    const list = data.files || [];
    $("fileCount").textContent = String(list.length);

    const box = $("files");
    box.innerHTML = "";

    if(list.length === 0){
      const empty = document.createElement("div");
      empty.className = "file";
      empty.innerHTML = `<div class="fileLeft"><i data-lucide="inbox"></i><b>No files</b></div>`;
      box.appendChild(empty);
    }else{
      for(const item of list){
        box.appendChild(renderFileRow(item));
      }
    }

    lucide.createIcons();
    setStatus("Ready.");
  }

  async function uploadFiles(files){
    const { token } = getAuth();
    if(!token) throw new Error("Not logged in.");

    const tooBig = [...files].find(f => f.size > MAX_FILE_BYTES);
    if(tooBig) throw new Error(`"${tooBig.name}" > 2MB`);

    setStatus("Uploading...");
    const form = new FormData();
    for(const f of files) form.append("files", f, f.name);

    await api("/api/upload-file", { method:"POST", token, form });
    await refreshFiles(true);
    setStatus("Ready.");
  }

  // ---------- UI Wiring ----------
  (function init(){
    applyTheme(localStorage.getItem("tv_theme") || "light");

    $("themeBtn").onclick = () => {
      const cur = document.documentElement.getAttribute("data-theme") || "light";
      applyTheme(cur === "light" ? "dark" : "light");
    };

    $("regUsername").value = randomUsername();

    $("tabRegister").onclick = () => {
      $("tabRegister").classList.add("active");
      $("tabLogin").classList.remove("active");
      $("panelRegister").classList.remove("hidden");
      $("panelLogin").classList.add("hidden");
    };

    $("tabLogin").onclick = () => {
      $("tabLogin").classList.add("active");
      $("tabRegister").classList.remove("active");
      $("panelLogin").classList.remove("hidden");
      $("panelRegister").classList.add("hidden");
    };

    $("btnRegister").onclick = async () => {
      try{
        const username = $("regUsername").value.trim() || randomUsername();
        setStatus("Registering...");
        const data = await api("/api/register", { method:"POST", json:{ username } });

        $("regToken").textContent = data.token;
        $("regResult").classList.remove("hidden");

        saveAuth(data.token, data.username);
        setStatus("Ready.");
      }catch(e){
        setStatus("Register failed.");
        alert(e.message);
      }
    };

    $("btnCopyToken").onclick = async () => {
      const t = $("regToken").textContent.trim();
      if(!t) return;
      await navigator.clipboard.writeText(t);
      setStatus("Copied.");
    };

    $("btnDownloadToken").onclick = () => {
      const t = $("regToken").textContent.trim();
      if(!t) return;
      downloadText("token.txt", t + "\n");
      setStatus("Downloaded.");
    };

    $("btnGoDashFromReg").onclick = async () => {
      try{ await showDash(); } catch(e){ alert(e.message); }
    };

    $("btnLogin").onclick = async () => {
      try{
        const token = $("loginToken").value.trim();
        if(!token) throw new Error("Missing token");
        setStatus("Logging in...");
        const data = await api("/api/login", { method:"POST", json:{ token } });
        saveAuth(token, data.username);
        await showDash();
      }catch(e){
        setStatus("Login failed.");
        alert(e.message);
      }
    };

    $("btnLogout").onclick = () => {
      clearAuth();
      showAuth();
    };

    $("btnCreateProject").onclick = async () => {
      try{
        const { token } = getAuth();
        setStatus("Creating...");
        await api("/api/create-project", { method:"POST", token, json:{ name:"My Project" } });
        await syncProjectUI();
      }catch(e){
        setStatus("Create failed.");
        alert(e.message);
      }
    };

    $("btnRefresh").onclick = async () => {
      try{ await refreshFiles(false); }catch(e){ alert(e.message); }
    };

    $("btnRun").onclick = async () => {
      try{
        const { token } = getAuth();
        setStatus("Running...");
        await api("/api/run", { method:"POST", token });
        setStatus("Ready.");
      }catch(e){
        setStatus("Run failed.");
        alert(e.message);
      }
    };

    $("btnDeleteAccount").onclick = () => {
      $("deleteBox").classList.remove("hidden");
      $("deleteConfirm").value = "";
      $("deleteConfirm").focus();
    };
    $("btnCancelDelete").onclick = () => $("deleteBox").classList.add("hidden");
    $("btnConfirmDelete").onclick = async () => {
      try{
        const v = $("deleteConfirm").value.trim();
        if(v !== "Delete Account") throw new Error("Type: Delete Account");
        const { token } = getAuth();
        setStatus("Deleting...");
        await api("/api/delete-account", { method:"DELETE", json:{ token } });
        clearAuth();
        showAuth();
      }catch(e){
        setStatus("Delete failed.");
        alert(e.message);
      }
    };

    // Upload
    const drop = $("drop");
    const picker = $("filePicker");

    drop.onclick = () => picker.click();
    drop.addEventListener("dragover", (e)=>{ e.preventDefault(); drop.classList.add("drag"); });
    drop.addEventListener("dragleave", ()=> drop.classList.remove("drag"));
    drop.addEventListener("drop", async (e)=>{
      e.preventDefault();
      drop.classList.remove("drag");
      if(!e.dataTransfer.files?.length) return;
      try{ await uploadFiles(e.dataTransfer.files); }catch(err){ alert(err.message); }
    });

    picker.addEventListener("change", async ()=>{
      if(!picker.files?.length) return;
      try{ await uploadFiles(picker.files); }catch(err){ alert(err.message); }
      picker.value = "";
    });

    // Auto-login
    const auth = getAuth();
    if(auth.token){
      api("/api/login", { method:"POST", json:{ token: auth.token } })
        .then(async (data)=>{
          saveAuth(auth.token, data.username);
          await showDash();
        })
        .catch(()=>{ clearAuth(); showAuth(); });
    }else{
      showAuth();
    }

    lucide.createIcons();
  })();
</script>
</body>
</html>
